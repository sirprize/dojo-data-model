<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>dojo-data-model/ModelCollection Test</title>
        <script type="text/javascript" src="config.js"></script>
        <script type="text/javascript" src="../vendor/dojo/dojo/dojo.js"></script>
        
        <script type="text/javascript">
            require([
                'doh',
                'dojo/when',
                'dojo/store/Cache',
                'dojo/store/Memory',
                'dojo/store/JsonRest',
                'dojo/store/Observable',
                'dojo-data-model/Observable',
                'dojo-data-model/test/MyModel',
                'dojo-data-model/ModelStore',
                'dojo/domReady!'
            ], function(
                doh,
                when,
                Cache,
                Memory,
                JsonRest,
                OriginalObservable,
                Observable,
                MyModel,
                ModelStore
            ){
                doh.register("dojo-data-model/ModelCollection (synchronous store tests))", [
                    {
                        name: 'Model Injection',
                        runTest: function () {
                            var store = ModelStore(MyModel, new Memory({
                                    idProperty: "id",
                                    data: [
                                        { id: 0, task: 'Task 0', due: '2012-12-21' },
                                        { id: 1, task: 'Task 1', due: '2013-01-01' },
                                        { id: 2, task: 'Task 2', due: '2014-01-01' }
                                    ]
                                })),
                                collection = store.query({})
                            ;
                            
                            collection.forEach(function (model) {
                                doh.assertTrue(/^Task/.test(model.get('task')));
                            });
                            
                            doh.assertTrue(collection.length === 3);
                            doh.assertTrue(collection.total === 3);
                        }
                    },
                    {
                        name: 'Observability',
                        runTest: function () {
                            var store = Observable(ModelStore(MyModel, new Memory({
                                    idProperty: "id",
                                    data: [
                                        { id: 0, task: 'Task 0', due: '2012-12-21' },
                                        { id: 1, task: 'Task 1', due: '2013-01-01' },
                                        { id: 2, task: 'Task 2', due: '2014-01-01' }
                                    ]
                                }))),
                                collection = store.query({});
                            ;
                            
                            collection.observe(function (model, removedIndex, insertedIndex) {
                                doh.assertTrue(/^Task 3/.test(model.get('task')));
                            });
                            
                            store.put({
                                id: 3,
                                task: 'Task 3',
                                due: '2015-01-01'
                            });
                        }
                    }
                ]);
                
                doh.register("dojo-data-model/ModelCollection (asynchronous store tests))", [
                    {
                        name: 'Model Injection',
                        runTest: function () {
                            var d = new doh.Deferred(),
                                store = ModelStore(MyModel, new JsonRest({
                                    idProperty: "id",
                                    target: './ModelCollection/'
                                })),
                                collection = store.query({})
                            ;
                            
                            collection.then(
                                function (models) {
                                    doh.assertTrue(models.length === 3);
                                    d.callback(true);
                                }
                            );
                            
                            return d;
                        }
                    },
                    {
                        name: 'Total',
                        runTest: function () {
                            var d = new doh.Deferred(),
                                store = ModelStore(MyModel, new JsonRest({
                                    idProperty: "id",
                                    target: './ModelCollection/'
                                })),
                                collection = store.query({})
                            ;
                            
                            collection.total.then(
                                function (total) {
                                    doh.assertTrue(total === 3);
                                    d.callback(true);
                                }
                            );
                            
                            return d;
                        }
                    },
                    {
                        name: 'Iterative Methods',
                        timeout: 3000,
                        runTest: function () {
                            var d = new doh.Deferred(),
                                store = ModelStore(MyModel, new JsonRest({
                                    idProperty: "id",
                                    target: './ModelCollection/'
                                })),
                                collection = store.query({}),
                                callbackConfirmed = false;
                            ;
                            
                            collection.forEach(function (model) {
                                doh.assertTrue(/^Task/.test(model.get('task')));
                                
                                if (!callbackConfirmed) {
                                    callbackConfirmed = true;
                                    d.callback(true);
                                }
                            });
                            
                            return d;
                        }
                    },
                    {
                        name: 'Observability',
                        timeout: 3000,
                        runTest: function () {
                            var d = new doh.Deferred(),
                                masterStore = Observable(ModelStore(MyModel, new JsonRest({
                                    idProperty: "id",
                                    target: './ModelCollection/'
                                }))),
                                memoryStore = new Memory({
                                    idProperty: "id"
                                }),
                                store = Cache(masterStore, memoryStore)
                                collection = store.query({}),
                                model = new MyModel({ store: masterStore })
                            ;
                            
                            collection.observe(function (model, removedIndex, insertedIndex) {
                                doh.assertTrue(model.get('task') === 'Task 3');
                                d.callback(true);
                            });
                            
                            model.set({
                                id: 'add.php',
                                task: 'Task 3',
                                due: new Date('2015-01-01')
                            });
                            
                            model.create();
                            
                            return d;
                        }
                    }
                ]);

                doh.run();
            });
        </script>
    </head>
    
    <body>
    </body>
</html>
