<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>dojo-data-model/QueryResults Test</title>
        <script type="text/javascript" src="config.js"></script>
        <script type="text/javascript" src="../vendor/dojo/dojo/dojo.js"></script>
        
        <script type="text/javascript">
            require([
                'doh',
                'dojo/store/JsonRest',
                'dojo/store/Memory',
                'dojo-data-model/test/MyModel',
                'dojo-data-model/ModelStore',
                'dojo/domReady!'
            ], function(
                doh,
                JsonRest,
                Memory,
                MyModel,
                ModelStore
            ){
                var modelInstantiator = function () {
                    return function (store) {
                        return function (item) {
                            var model = new MyModel({ store: store });
                            model.deserialize(item);
                            return model;
                        }
                    }
                };
                
                doh.register("dojo-data-model/ModelStore (query() tests)", [
                    {
                        name: 'query()',
                        runTest: function () {
                            var store = ModelStore(new Memory({}), MyModel),
                                results = store.query({})
                            ;
                            
                            doh.assertTrue(typeof results.forEach === 'function');
                            doh.assertTrue(typeof results.filter === 'function');
                            doh.assertTrue(typeof results.map === 'function');
                        }
                    }
                ]);
                
                doh.register("dojo-data-model/ModelStore (get() tests)", [
                    {
                        name: 'synchronous',
                        runTest: function () {
                            var store = ModelStore(new Memory({
                                    idProperty: "id",
                                    data: [
                                        { id: 0, task: 'Task 1', due: '2012-12-21' }
                                    ]
                                }), MyModel),
                                model = store.get(0);
                            ;
                            
                            doh.assertTrue(typeof model.serialize === 'function');
                            doh.assertTrue(typeof model.deserialize === 'function');
                            doh.assertTrue(typeof model.validate === 'function');
                        }
                    },
                    {
                        name: 'asynchronous',
                        runTest: function () {
                            var d = new doh.Deferred(),
                                store = ModelStore(new JsonRest({
                                    idProperty: "id",
                                    target: './api/default/'
                                }), MyModel),
                                promise = store.get(0)
                            ;
                            
                            promise.then(
                                function (model) {
                                    doh.assertTrue(model.get('task') === 'Task 1');
                                    d.callback(true);
                                }
                            );
                            
                            return d;
                        }
                    }
                ]);
                
                doh.run();
            });
        </script>
    </head>
    
    <body>
    </body>
</html>
