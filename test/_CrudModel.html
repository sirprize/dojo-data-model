<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>dojo-data-model/_CrudModel Test</title>
        <script type="text/javascript" src="config.js"></script>
        <script type="text/javascript" src="../vendor/dojo/dojo/dojo.js"></script>
        
        <script type="text/javascript">
            require([
                'doh',
                'dojo/when',
                'dojo/store/Memory',
                'dojo/store/JsonRest',
                'dojo-data-model/test/MyModel',
                'dojo/domReady!'
            ], function(
                doh,
                when,
                Memory,
                JsonRest,
                MyModel
            ){
                doh.register("dojo-data-model/_CrudModel (create/save() tests)", [
                    {
                        name: 'Client-Side Validation',
                        timeout: 3000,
                        runTest: function () {
                            var d = new doh.Deferred(),

                                store = new JsonRest({
                                    target: null
                                }),

                                model = MyModel({
                                    store: store
                                })
                            ;
                                
                            model.save().then(
                                null,
                                function (error) {
                                    doh.assertTrue(error.code === 'invalid-input');
                                    d.callback(true);
                                }
                            );

                            return d;
                        }
                    },
                    {
                        name: 'Http 200 Response',
                        timeout: 3000,
                        runTest: function () {
                            var d = new doh.Deferred(),

                                store = new JsonRest({
                                    target: './_CrudModel/create-ok.php'
                                }),

                                model = MyModel({
                                    store: store
                                }),
                                
                                task = 'Some task'
                            ;

                            model.set({
                                task: task
                            });

                            model.save().then(
                                function (m) {
                                    doh.is(m.get('task'), task);
                                    d.callback(true);
                                }
                            );

                            return d;
                        }
                    },
                    {
                        name: 'Http 422 Response',
                        timeout: 3000,
                        runTest: function () {
                            var d = new doh.Deferred(),

                                store = new JsonRest({
                                    target: './_CrudModel/create-invalid.php'
                                }),

                                model = MyModel({
                                    store: store
                                })
                            ;

                            model.set({
                                task: 'Some task'
                            });

                            model.save().then(
                                null,
                                function (error) {
                                    doh.assertTrue(error.code === 'invalid-input');
                                    d.callback(true);
                                }
                            );

                            return d;
                        }
                    }
                ]);
                
                doh.register("dojo-data-model/_CrudModel (update/save() tests)", [
                    {
                        name: 'Client-Side Validation',
                        timeout: 3000,
                        runTest: function () {
                            var d = new doh.Deferred(),

                                store = new JsonRest({
                                    target: null
                                }),

                                model = MyModel({
                                    store: store
                                })
                            ;

                            model.set({
                                id: 'abc'
                            });

                            model.save().then(
                                null,
                                function (error) {
                                    doh.assertTrue(error.code === 'invalid-input');
                                    d.callback(true);
                                }
                            );

                            return d;
                        }
                    },
                    {
                        name: 'Http 200 Response',
                        timeout: 3000,
                        runTest: function () {
                            var d = new doh.Deferred(),

                                store = new JsonRest({
                                    target: './_CrudModel/'
                                }),

                                model = MyModel({
                                    store: store
                                }),
                                
                                task = 'Some task'
                            ;

                            model.set({
                                id: 'update-ok.php',
                                task: task
                            });

                            model.save().then(
                                function (m) {
                                    doh.is(m.get('task'), task);
                                    d.callback(true);
                                }
                            );

                            return d;
                        }
                    },
                    {
                        name: 'Http 404 Response',
                        timeout: 3000,
                        runTest: function () {
                            var d = new doh.Deferred(),

                                store = new JsonRest({
                                    target: './_CrudModel/'
                                }),

                                model = MyModel({
                                    store: store
                                }),
                                
                                task = 'Some task'
                            ;

                            model.set({
                                id: 'update-not-found.php',
                                task: task
                            });

                            model.save().then(
                                null,
                                function (error) {
                                    doh.assertTrue(error.code === 'not-found');
                                    d.callback(true);
                                }
                            );

                            return d;
                        }
                    },
                    {
                        name: 'Http 422 Response',
                        timeout: 3000,
                        runTest: function () {
                            var d = new doh.Deferred(),

                                store = new JsonRest({
                                    target: './_CrudModel/'
                                }),

                                model = MyModel({
                                    store: store
                                })
                            ;

                            model.set({
                                id: 'update-invalid.php',
                                task: 'Some task'
                            });

                            model.save().then(
                                null,
                                function (error) {
                                    doh.assertTrue(error.code === 'invalid-input');
                                    d.callback(true);
                                }
                            );

                            return d;
                        }
                    }
                ]);
                
                doh.register("dojo-data-model/_CrudModel (remove() tests)", [
                    {
                        name: 'remove() ok in synchronous store',
                        timeout: 3000,
                        runTest: function () {
                            
                            var store = new Memory({ idProperty: "id" }),
                                myModel = new MyModel({ store: store })
                            ;
                            
                            myModel.deserialize({
                                task: 'Task 1',
                                due: '2012-12-21'
                            });
                            
                            myModel.save();
                            myModel.remove();
                            doh.assertTrue(myModel.get('id') === '');
                        }
                    },
                    {
                        name: 'remove() ok in asynchronous store',
                        timeout: 3000,
                        runTest: function () {
                            
                            var d = new doh.Deferred(),
                                store = new JsonRest({
                                     target: './_CrudModel/'
                                }),
                                myModel = new MyModel({ store: store })
                            ;

                            myModel.deserialize({
                                id: 'remove-ok.php',
                                task: 'Task 1',
                                due: '2012-12-21'
                            });

                            myModel.remove().then(
                                function (model) {
                                    doh.assertTrue(myModel.get('id') === '');
                                    d.callback(true);
                                }
                            );
                            
                            return d;
                        }
                    },
                    {
                        name: 'remove() not found in asynchronous store',
                        timeout: 3000,
                        runTest: function () {
                            
                            var d = new doh.Deferred(),
                                store = new JsonRest({
                                     target: './_CrudModel/'
                                }),
                                myModel = new MyModel({ store: store })
                            ;

                            myModel.deserialize({
                                id: 'remove-not-found.php',
                                task: 'Task 1',
                                due: '2012-12-21'
                            });

                            myModel.remove().then(
                                null,
                                function (error) {
                                    doh.assertTrue(error.code === 'not-found');
                                    d.callback(true);
                                }
                            );
                            
                            return d;
                        }
                    }
                ]);
                
                doh.run();
            });
        </script>
    </head>
    
    <body>
    </body>
</html>
